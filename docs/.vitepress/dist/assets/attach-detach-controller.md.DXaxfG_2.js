import{_ as e,c as a,o as i,ae as t}from"./chunks/framework.CDjunVez.js";const k=JSON.parse('{"title":"Attach detach controller","description":"","frontmatter":{},"headers":[],"relativePath":"attach-detach-controller.md","filePath":"attach-detach-controller.md"}'),n={name:"attach-detach-controller.md"};function l(h,s,o,p,d,r){return i(),a("div",null,[...s[0]||(s[0]=[t(`<h1 id="attach-detach-controller" tabindex="-1">Attach detach controller <a class="header-anchor" href="#attach-detach-controller" aria-label="Permalink to &quot;Attach detach controller&quot;">​</a></h1><h2 id="summary" tabindex="-1">Summary <a class="header-anchor" href="#summary" aria-label="Permalink to &quot;Summary&quot;">​</a></h2><p>The Attach/Detach controller manages volume attach and detach operations.</p><p>NOTE: this analysis assumes that CSIMigration is turned on, therefore the paths that use the intree plugins are not part of this analysis (like the intreeToCSITranslator).</p><p>The attach/detach controller is initialized in the kube-controller-manager (kcm), the kcm initializes many builtin controllers in <a href="https://github.com/kubernetes/kubernetes/blob/132f29769dfecfc808adc58f756be43171054094/cmd/kube-controller-manager/app/controllermanager.go#L450" target="_blank" rel="noreferrer">NewControllerInitializers</a>, the function <a href="https://github.com/kubernetes/kubernetes/blob/132f29769dfecfc808adc58f756be43171054094/cmd/kube-controller-manager/app/core.go#L299" target="_blank" rel="noreferrer"><code>startAttachDetachController</code></a> is the starting point.</p><h2 id="setup-func-newattachdetachcontroller" tabindex="-1">Setup <code>func NewAttachDetachController(</code> <a class="header-anchor" href="#setup-func-newattachdetachcontroller" aria-label="Permalink to &quot;Setup \`func NewAttachDetachController(\`&quot;">​</a></h2><p><code>func NewAttachDetachController(</code> is initialized with many shared informers for Kinds like: Pod, Node, PVC, PV, CSINode, CSIDriver, VolumeAttachment, an instance of <code>attachDetachController</code> is created with listers and informers for the above Kinds, it also has a <code>workqueue</code> for PVCs.</p><p>There are 4 important objects created in the setup that are the core of the controller:</p><ul><li><code>DesiredStateOfTheWorld</code> (abbreviated as DSW)</li><li><code>ActualStateOfTheWorld</code> (abbreviated as ASW)</li><li><code>Reconciler</code></li><li><code>DesiredStateOfTheWorldPopulator</code> (abbreviated as DSWP)</li></ul><p>There are additional objects that help update the status of objects:</p><ul><li><code>NodeStatusUpdater</code></li><li><code>Broadcaster</code></li></ul><p>During the setup we add event handlers for the informers</p><ul><li>pod add, update and delete callbacks</li><li>node add, update, delete callbacks</li><li>pvc add and update callbacks</li></ul><p>In addition there&#39;s an indexer by pvc in the pod informer, the comment explains it:</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// This custom indexer will index pods by its PVC keys. Then we don&#39;t need</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// to iterate all pods every time to find pods whichereference given PVC.</span></span></code></pre></div><h2 id="func-adc-attachdetachcontroller-run" tabindex="-1"><code>func (adc *attachDetachController) Run</code> <a class="header-anchor" href="#func-adc-attachdetachcontroller-run" aria-label="Permalink to &quot;\`func (adc *attachDetachController) Run\`&quot;">​</a></h2><p>Wait for all the informers to sync, populate the actual state of the world, and the desired state of the world, start the reconciler in a goroutine, the desired state of the world populator in another goroutine and wait for PVC items to come out of the workqueue.</p><p>To populate the ASW we list the nodes in the cluster and gather all the volumes attached by checking the <code>node.Status.VolumesAttached</code>, in the ASW we mark a volume as attached if it&#39;s seen here, we also process the list of volumes in use in <code>node.Status.VolumesInUse</code>, a volume is marked as <em>mounted</em> if it&#39;s both attached and in use i.e. if it&#39;s in both lists, next, we add the node to the DSW in the <code>dsw.nodesManaged</code> field.</p><p>The last step of the ASW population is to process the VolumeAttachments (VA), a volume attachment is the intent to attach a volume, the comment in the <code>processVolumeAttachment</code> function explains it well:</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// For each VA object, this function checks if its present in the ASW.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// If not, adds the volume to ASW as an &quot;uncertain&quot; attachment.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// In the reconciler, the logic checks if the volume is present in the DSW;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//   if yes, the reconciler will attempt attach on the volume;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//   if not (could be a dangling attachment), the reconciler will detach this volume.</span></span></code></pre></div><p>To populate the DSW we list pods and iterate over them, for every pod we determine the action <code>addToVolume</code> to take for the pod and its volumes which is to either add them to the DSWP or remove them from the DSW, to do so, we iterate over the <code>pod.Spec.Volumes</code>, we create a <code>VolumeSpec</code> (a mutable copy of the existing one with any PVC dereferenced to get its PV)</p><p>If <code>addToVolume</code> is true then we add the pod to the list of pods that reference the specified volume (if it wasn&#39;t already added before), the volume to attach is added to the DSW as follows, read <code>func (dsw *desiredStateOfWorld) AddPod</code></p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// add volume to the DSW</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">volumeObj, volumeExists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nodeObj.volumesToAttach[volumeName]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">volumeExists {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  volumeObj </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> volumeToAttach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    multiAttachErrorReported: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    volumeName:               volumeName,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    spec:                     volumeSpec,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    scheduledPods:            </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">types</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">UniquePodName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  dsw.nodesManaged[nodeName].volumesToAttach[volumeName] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> volumeObj</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// add pod to the DSW (if it didn&#39;t exist before)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _, podExists </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> volumeObj.scheduledPods[podName]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">podExists {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  dsw.nodesManaged[nodeName].volumesToAttach[volumeName].scheduledPods[podName] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    pod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      podName: podName,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      podObj:  podToAdd,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>If <code>addToVolume</code> is false then we remove it with the DSW with the reverse operation of above, read <code>func (dsw *desiredStateOfWorld) DeletePod</code></p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// remove the pod from the list of scheduled pods for the volume</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  dsw.nodesManaged[nodeName].volumesToAttach[volumeName].scheduledPods,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  podName)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// the volume is only deleted once there are no references from Pods to it</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> len</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(volumeObj.scheduledPods) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dsw.nodesManaged[nodeName].volumesToAttach,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    volumeName)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Still in the populate DSW, after adding the pod and its volumes to the DSW we replace the volumes specs in the ASW with the correct ones found in the pods, also the volumes in the pod which are marked as attached, this is if <code>asw.attachedVolumes[volumeName].nodesAttachedTo[nodeName]</code> exists and its <code>attachConfirmed</code> property is set to true (note a few volumes were marked as uncertain before using the VA objects) are marked as attached (read <code>MarkVolumeAsAttached &gt; AddVolumeNode</code>), I believe only its <code>devicePath</code> property is updated because it&#39;s already marked as attached.</p><h2 id="reconciler-func-rc-reconciler-run" tabindex="-1">Reconciler <code>func (rc *reconciler) Run</code> <a class="header-anchor" href="#reconciler-func-rc-reconciler-run" aria-label="Permalink to &quot;Reconciler \`func (rc *reconciler) Run\`&quot;">​</a></h2><p>It follows the common pattern for reconcilers <code>wait.Until(fn, 100ms, stop)</code>, fn is <code>func (rc *reconciler) reconcile()</code>, the code simplifies to:</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">rc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reconciler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">reconcile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  detachASWAttachedVolumes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  attachDSWVolumesToAttach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><code>reconcile</code> handles detaches first, there are many interesting cases including <a href="https://github.com/kubernetes/kubernetes/issues/93902" target="_blank" rel="noreferrer">https://github.com/kubernetes/kubernetes/issues/93902</a>, the code simplifies to:</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _, attachedVolume </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ASW.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GetAttachedVolumes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DSW.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">VolumeExists</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(attachedVolume) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // lots of checks to make sure that the detach is safe</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reconciler.attacherDetacher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DetachVolume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(attachedVolume)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // so that NodeStatusUpdater will add it back to the VolumeAttached list</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ASW.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">AddVolumeToReportAsAttached</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(attachedVolume)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><code>reconcile</code> handles attach next, the code simplifies to:</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _, volumeToAttach </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DSW.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GetVolumesToAttach</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // lots of checks to make sure that the attach is safe</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> reconciler.attacherDetacher.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">AttachVolume</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(volumeToAttach)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="dswp-func-dswp-desiredstateofworldpopulator-run" tabindex="-1">DSWP <code>func (dswp *desiredStateOfWorldPopulator) Run</code> <a class="header-anchor" href="#dswp-func-dswp-desiredstateofworldpopulator-run" aria-label="Permalink to &quot;DSWP \`func (dswp *desiredStateOfWorldPopulator) Run\`&quot;">​</a></h2><p>The DSWP removes/adds the volumes found in pods to the DSW.</p><p>For the removal, it iterates over the pods added to the DSW and checks if the pod is still available in the API server through the informer, if it&#39;s not in the informer then it&#39;s deleted from the DSW.</p><p>For the addition, it lists all the pods in the informer and if it&#39;s not terminated it iterates over all the <code>pod.Spec.Volumes</code> and adds the <code>&lt;pod, volume&gt;</code> to the DSW</p>`,37)])])}const E=e(n,[["render",l]]);export{k as __pageData,E as default};
