import{_ as i,c as a,o as e,ae as n}from"./chunks/framework.CDjunVez.js";const d=JSON.parse('{"title":"Kube Controller Manager","description":"","frontmatter":{},"headers":[],"relativePath":"kube-controller-manager.md","filePath":"kube-controller-manager.md"}'),t={name:"kube-controller-manager.md"};function l(h,s,p,r,o,k){return e(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="kube-controller-manager" tabindex="-1">Kube Controller Manager <a class="header-anchor" href="#kube-controller-manager" aria-label="Permalink to &quot;Kube Controller Manager&quot;">​</a></h1><p>The kube controller manager (kcm) is a component bundled with Kubernetes that runs in the control plane and embeds the core control loops.</p><h2 id="summary" tabindex="-1">Summary <a class="header-anchor" href="#summary" aria-label="Permalink to &quot;Summary&quot;">​</a></h2><p>The starting point is the <a href="https://github.com/kubernetes/kubernetes/blob/master/cmd/kube-controller-manager/app/controllermanager.go#L176" target="_blank" rel="noreferrer"><code>Run</code></a> function which in addition to initializing health endpoints it starts the bundled set of controllers, the first controller that initializes is the <code>ServiceAccountTokenController</code> which must be initialized before the others, the comment for the struct <code>serviceAccountTokenControllerStarter</code> summarizes it well</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>// serviceAccountTokenControllerStarter is special because it must run first to set up permissions for other controllers.</span></span>
<span class="line"><span>// It cannot use the &quot;normal&quot; client builder, so it tracks its own. It must also avoid being included in the &quot;normal&quot;</span></span>
<span class="line"><span>// init map so that it can always run first.</span></span></code></pre></div><p>Before all the controllers including the <code>ServiceAccountTokenController</code> start there&#39;s the creation of a <a href="https://github.com/kubernetes/kubernetes/blob/132f29769dfecfc808adc58f756be43171054094/cmd/kube-controller-manager/app/controllermanager.go#L498:6" target="_blank" rel="noreferrer"><code>ControllerContext</code></a> object which is a shared context object for all the controllers, we need a single object because there are some objects that shouldn&#39;t be initialized many times (e.g. a sharedInformer with its versioned client, metadata sharedInformer with its versioned client).</p><p>With the <code>ControllerContext</code> initialized, we can start the controller initialization, as mentioned, first the serviceAccountTokenControllerStarter is initialized and then other controllers located at <a href="https://github.com/kubernetes/kubernetes/blob/master/cmd/kube-controller-manager/app/controllermanager.go#L416" target="_blank" rel="noreferrer">cmd/kube-controller-manager/app/controllermanager.go</a>.</p><h2 id="development" tabindex="-1">Development <a class="header-anchor" href="#development" aria-label="Permalink to &quot;Development&quot;">​</a></h2><p>In the kubernetes codebase, compile the kube-controller-manager binary:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> WHAT=cmd/kube-controller-manager</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DBG=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span></code></pre></div><p>Print all the flags available with <code>./_output/bin/kube-controller-manager --help</code>.</p><p>Assuming that you have a working k8s cluster (e.g. the kind cluster setup in <code>kind-sandbox/</code>) you&#39;ll see that the kube-controller-manager is already running as a static Pod. To disable it login into the Node and move the file from the location where the kubelet watches for manifests to run.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -it</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># verify that the kube-controller-manager pod is running</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">crictl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ps</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># move the static Pod so that it&#39;s no longer watched</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/kubernetes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> manifests-tmp</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> manifests/kube-controller-manager.yaml</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> manifests-tmp</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># verify that the kube-controller-manager pod is no longer running</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">crictl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ps</span></span></code></pre></div><p>To run the binary locally connected to a running kube-apiserver:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./_output/bin/kube-controller-manager</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --kubeconfig=\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HOME</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}/.kube/config</span></span></code></pre></div><p>To run a subset of the controllers use the flag <code>--controllers</code> e.g. <code>--controllers persistentvolume-binder</code> (search for <code>func NewControllerInitializers(loopMode ControllerLoopMode)</code> in the file cmd/kube-controller-manager/app/controllermanager.go</p><p>To run the binary in debug mode:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># debugging the PV controller, resync never happens</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dlv</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --listen</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :38697</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --accept-multiclient</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --api-version=2</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --headless</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  exec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./_output/bin/kube-controller-manager</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  --kubeconfig=\${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">HOME</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}/.kube/config</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --leader-elect=false</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --v=4</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --controllers=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;persistentvolume-binder,pvc-protection,pv-protection&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --pvclaimbinder-sync-period=10000h</span></span></code></pre></div><p>Next connect to this instance through your editor, my <a href="https://github.com/mauriciopoppe/dotfiles/blob/main/neovim/config/plugins/nvim-dap.vim" target="_blank" rel="noreferrer">nvim-dap lua config</a> to connect to it:</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;go&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Attach kube-controller-manager (remote)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    debugAdapter </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;dlv-dap&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    request </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;attach&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    mode </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;remote&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    host </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;127.0.0.1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    port </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;38697&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    stopOnEntry </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    substitutePath </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          from </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;\${workspaceFolder}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          to </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;/Users/mauriciopoppe/go/src/k8s.io/kubernetes/_output/local/go/src/k8s.io/kubernetes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span></code></pre></div><p>To undo the kube-controller-manager setup and run the static Pod again:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -it</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-control-plane</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># move the static Pod so that it&#39;s watched again</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /etc/kubernetes</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mv</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> manifests-tmp/kube-controller-manager.yaml</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> manifests</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># verify that the kube-controller-manager pod is running</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">crictl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ps</span></span></code></pre></div>`,22)])])}const g=i(t,[["render",l]]);export{d as __pageData,g as default};
