import{_ as i,c as a,o as n,ae as e}from"./chunks/framework.CDjunVez.js";const o=JSON.parse('{"title":"containerd","description":"","frontmatter":{},"headers":[],"relativePath":"containerd.md","filePath":"containerd.md"}'),t={name:"containerd.md"};function h(l,s,p,k,r,d){return n(),a("div",null,[...s[0]||(s[0]=[e(`<h1 id="containerd" tabindex="-1">containerd <a class="header-anchor" href="#containerd" aria-label="Permalink to &quot;containerd&quot;">â€‹</a></h1><h2 id="containerd-setup-in-kind" tabindex="-1">containerd setup in kind <a class="header-anchor" href="#containerd-setup-in-kind" aria-label="Permalink to &quot;containerd setup in kind&quot;">â€‹</a></h2><p>From the containerd <a href="https://github.com/containerd/containerd/blob/main/docs/getting-started.md" target="_blank" rel="noreferrer">getting started page</a> we need to: install containerd (binary), configure containerd to start through systemd, install runc (binary), install CNI plugins.</p><p>The kind base image defines the binaries to build binaries for:</p><ul><li><a href="https://github.com/kubernetes-sigs/kind/blob/7c2f6c1dcd332c039ac3e7d3e3dc0dd1ec2e6a6d/images/base/Dockerfile#L122" target="_blank" rel="noreferrer">containerd</a></li><li><a href="https://github.com/kubernetes-sigs/kind/blob/7c2f6c1dcd332c039ac3e7d3e3dc0dd1ec2e6a6d/images/base/Dockerfile#L139" target="_blank" rel="noreferrer">runc</a></li><li><a href="https://github.com/kubernetes-sigs/kind/blob/7c2f6c1dcd332c039ac3e7d3e3dc0dd1ec2e6a6d/images/base/Dockerfile#L152" target="_blank" rel="noreferrer">crictl</a></li><li><a href="https://github.com/kubernetes-sigs/kind/blob/7c2f6c1dcd332c039ac3e7d3e3dc0dd1ec2e6a6d/images/base/Dockerfile#L165" target="_blank" rel="noreferrer">cni</a></li></ul><p>And configuration to start containerd:</p><ul><li><a href="https://github.com/kubernetes-sigs/kind/blob/7c2f6c1dcd332c039ac3e7d3e3dc0dd1ec2e6a6d/images/base/files/etc/containerd/config.toml" target="_blank" rel="noreferrer">/etc/containerd/config.toml</a></li><li><a href="https://github.com/kubernetes-sigs/kind/blob/7c2f6c1dcd332c039ac3e7d3e3dc0dd1ec2e6a6d/images/base/files/etc/systemd/system/containerd.service" target="_blank" rel="noreferrer">/etc/systemd/system/containerd.service</a></li></ul><h2 id="building-containerd-from-source" tabindex="-1">Building containerd from source <a class="header-anchor" href="#building-containerd-from-source" aria-label="Permalink to &quot;Building containerd from source&quot;">â€‹</a></h2><p>Read the <a href="https://github.com/containerd/containerd/blob/main/BUILDING.md" target="_blank" rel="noreferrer">containerd building docs</a>.</p><p>Clone the containerd and runc repos under the same folder e.g.</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/go/src/github.com/containerd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -la</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">total</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drwxr-xr-x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mauriciopoppe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  staff</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   128</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Feb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 19</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 15:35</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drwxr-xr-x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   9</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mauriciopoppe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  staff</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   288</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Feb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 19</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 15:35</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ..</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drwxr-xr-x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  50</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mauriciopoppe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  staff</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  1600</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Feb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 19</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 15:36</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drwxr-xr-x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  64</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mauriciopoppe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  staff</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  2048</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Feb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 19</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 15:35</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> runc</span></span></code></pre></div><p>Create the file <code>Dockerfile.dev</code> at this level:</p><div class="language-dockerfile vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> golang</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> apt-get update &amp;&amp; \\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    apt-get install -y libseccomp-dev</span></span></code></pre></div><p>Build the image:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Dockerfile.dev</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd/build</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span></span></code></pre></div><p>Create a build container based on this image mounting both the containerd and runc codebases:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -it</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --privileged</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -v</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/containerd</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -v</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${PWD}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/runc:/go/src/github.com/opencontainers/runc</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -v</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \${PWD}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/containerd:/go/src/github.com/containerd/containerd</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> GOPATH=/go</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    -w</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /go/src/github.com/containerd/containerd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd/build</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sh</span></span></code></pre></div><p>Build containerd:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># in the build container:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /go/src/github.com/containerd/containerd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># in the host:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -la</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bin</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">total</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 200008</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drwxr-xr-x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   6</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mauriciopoppe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  staff</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">       192</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Feb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 19</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 15:43</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drwxr-xr-x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  50</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mauriciopoppe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  staff</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      1600</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Feb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 19</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 15:43</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ..</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-rwxr-xr-x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mauriciopoppe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  staff</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  49633057</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Feb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 19</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 15:43</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-rwxr-xr-x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mauriciopoppe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  staff</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  12386456</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Feb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 19</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 15:43</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd-shim-runc-v2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-rwxr-xr-x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mauriciopoppe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  staff</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  19923265</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Feb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 19</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 15:43</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd-stress</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-rwxr-xr-x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mauriciopoppe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  staff</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  20447553</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Feb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 19</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 15:43</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ctr</span></span></code></pre></div><p>Build runc:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># in the build container:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /go/src/github.com/opencontainers/runc</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># in the host the binary is at the root of ./runc</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/go/src/github.com/containerd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -la</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> runc</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> runc</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">-rwxr-xr-x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mauriciopoppe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  staff</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  13621536</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Feb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 19</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 15:44</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> runc</span></span></code></pre></div><h2 id="using-dev-binaries-of-containerd-and-runc-in-kind" tabindex="-1">Using dev binaries of containerd and runc in kind <a class="header-anchor" href="#using-dev-binaries-of-containerd-and-runc-in-kind" aria-label="Permalink to &quot;Using dev binaries of containerd and runc in kind&quot;">â€‹</a></h2><p>The steps are very similar to my kubelet debug guide</p><ul><li>one time env setup <ul><li>Install tools that will allow debugging like delve and grc</li><li>Install a custom systemd config for containerd that runs it through delve</li><li>Install a pretty log formatter for grc, this is optional but I like a way to distinguish different lines logged by journalctl</li><li>Configure your editor to connect to the server</li></ul></li><li>normal workflow <ul><li>make changes in the containerd codebase, recompile containerd and sync it to the kind node</li><li>restart the containerd service</li><li>make your editor forward breakpoints to the delve server</li><li>delve will stop at the breakpoints set ðŸ¥³</li></ul></li></ul><h3 id="instrument-the-kind-node-for-debugging-through-a-sidecar-automated-one-time-setup" tabindex="-1">Instrument the kind node for debugging through a sidecar (automated one time setup) <a class="header-anchor" href="#instrument-the-kind-node-for-debugging-through-a-sidecar-automated-one-time-setup" aria-label="Permalink to &quot;Instrument the kind node for debugging through a sidecar (automated one time setup)&quot;">â€‹</a></h3><ul><li>Install cdebug</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>GOOS=darwin</span></span>
<span class="line"><span>GOARCH=arm64</span></span>
<span class="line"><span>curl -Ls https://github.com/iximiuz/cdebug/releases/latest/download/cdebug_\${GOOS}_\${GOARCH}.tar.gz | tar xvz</span></span>
<span class="line"><span>sudo mv cdebug /usr/local/bin</span></span>
<span class="line"><span></span></span>
<span class="line"><span>cdebug --version</span></span>
<span class="line"><span>cdebug version 0.0.17</span></span></code></pre></div><ul><li>Build the containerd-debug:latest sidecar (the Dockerfile is in this repo)</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># PWD is the root of this repo</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ./debug</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd-debug</span></span></code></pre></div><ul><li>Instrument any <code>kind-worker</code> container</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cdebug</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --image</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd-debug:latest</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -it</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker://kind-worker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;$CDEBUG_ROOTFS/app/containerd-debug-entrypoint.sh&#39;</span></span></code></pre></div><h3 id="regular-workflow" tabindex="-1">Regular workflow <a class="header-anchor" href="#regular-workflow" aria-label="Permalink to &quot;Regular workflow&quot;">â€‹</a></h3><p>In the containerd codebase, recompile containerd with the instructions above and run it in the worker:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># in the build container:</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /go/src/github.com/containerd/containerd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;&amp; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># sync dev version of containerd</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd/bin/containerd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-worker:/usr/local/bin/containerd-debug</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-worker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bash</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;systemctl daemon-reload; systemctl restart containerd-debug&quot;</span></span></code></pre></div><p>In another terminal, exec into the kind-worker container and see the containerd output</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -it</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> kind-worker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bash</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">journalctl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --since</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;$(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> show </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">-p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ActiveEnterTimestamp containerd-debug </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> awk</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{print $2 $3}&#39;)&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -u</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> containerd-debug</span></span></code></pre></div>`,36)])])}const c=i(t,[["render",h]]);export{o as __pageData,c as default};
